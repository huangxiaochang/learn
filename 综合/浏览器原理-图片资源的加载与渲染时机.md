浏览器原理之图片资源加载与渲染时机
==============================

## 图片资源加载与渲染时机

### <img>标签中的图片
<img>标签中的图片是在文档解析到时，进行加载。渲染的时机为在dom树和css树匹配构建渲染树时，决定是否会渲染该img中的图片，然后会经过分层，分块，合成等步骤之后，最终渲染显示在屏幕上。

### 背景中的图片
在css解析时，遇到背景图片，并不会进行加载，背景图片的加载时机为：dom树和css树匹配构建渲染树时，遍历dom树上的元素，如果发现该元素的样式规则上有background-image属性时，会去加载该图片。在此时，如果该元素设置display:none,也不会出现在渲染树中，所以背景图片也不会被渲染。

### js代码中动态创建的img标签
js代码中动态创建的img标签的加载时机为：为创建的img标签指定src属性时。该图片是否在dom树中，取决于是否把该img标签插入到dom树中，渲染的时机为构建渲染树时，该图片是否可见，如果可见，则会在后续构成中渲染显示。(如果动态img加载图片的js脚本是在onload或者setTimeout之前执行，那么该图片也会先于背景图片加载)。

**综上所述：<img>标签中的图片是先于样式规则中的背景图片加载的，因为<img>中的图片的加载是在dom树构建时，而背景图片是否加载时在构建渲染树时。所以如果想要使用背景图片作为占位符时，可能达不到想要的结果，因为背景图片是在img标签图片之后才开始加载的，有可能img图片加载完成后，背景图片还没开始加载**

## 设置了display: none的元素

设置了display: none的元素，图片不会渲染出来，但是会加载。

原理：
当浏览器解析到<img>标签时，会去加载该图片。构建完dom树后，会和css树进行匹配构建渲染树，对于设置了display:none的元素，不会出现在渲染树中。构建完渲染树后，会进行分块，分层，合成，最终绘制到屏幕。所以设置了display: none的元素，图片不会渲染出来，但是会加载。

## 伪类中的背景图片
对于如下的伪类背景图片：
```
.img-wrap {
	background-image: url('./123.png');
}
.img-wrap {
	background-image: url('./456.png');
}

<div class="img-wrap"></div>
```
在触发hover之前，图片加载和渲染的是123.png.456.png不会被加载。
在触发hover之后，才会去加载456.png并渲染它。

原理：
在hover之前，在dom树和css树构建渲染树时，匹配到的样式规则是img-wrap，所以会加载123.png并在之后的流程中渲染显示它。
在hover触发之后，因为hover的优先级高，所以在构建渲染树的过程，该元素匹配到了有hover的规则，所以会加载和渲染456.png。

## 设置了display:none的元素的子元素的背景图片
对于设置了display:none的元素，在构建渲染树时，不会继续遍历它的子元素来应用样式规则，所以它的子元素的背景图片样式不会被应用到，所以子元素的背景图片不会被加载和渲染。（设置display:none的元素的<img>子元素是会被加载的，因为<img>的图片的加载是在dom树解析时，而不是在构建渲染树时）

## 指向相同url的图片
指向相同的url的图片资源只会加载一次。

## 不存在的元素的背景图片
对于不在dom树中的元素的样式背景图片，是不会被加载和渲染的。